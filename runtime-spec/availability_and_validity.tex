\chapter{Availibility and Validity Verification}

\section{Introduction}
Validators are reposible for the validity of PoV blocks. There two phases of validation that takes place in the AnV protocol. The primary validation check that hapens by parachain validators who are assigned to the parachain who has produced the PoV block. The secondary check is happening by one or more randomly assigned validators to make sure colluding parachain validators may not get away with validating a PoV that is invalid and not keeping it availblet to avoid the possiblity of being punished for the attack. The security analysis in the end of this documents dives deeper into the incentives of the ncessity of a a availbility checking that also serves as the secondary validty checking. 

Once parachain validators have validated a PoV block successfully they either have to send a proposal for it to the realy chain or confirm a proposal sent in from another parachain validator. 

Once the porposal of a PoV block is on chain, the parachain validators break down the PoV block into erasure coded pieces and distribute them among all validator. See \ref{distribute-pieces} for details on how this distribution takes place.

Once validators have received erasure coded pieces for a number of PoVs for this round that were proposed earlier on the relay chain, they announce this on the relay chain. As sson as 2/3 of validators have made this announcement a in \ref{shot-assignment} assigns every validator one of these PoV blocks to check its validity. A validator checks the validity of the PoV it is assigned to by obtaining the PoV block (see \ref{obtaining-block}) and comparing it to the original proposal of it that is on chain. 

Note that every validator will find out whether a PoV has been checked in the secndary validity checking. 

If a block has been checked at least by one validator, the rest of the validators continute with voting on that block in the GRANDPA protocol. 

If validators notice that a equvication has happened an additnal validty/availbity checking will take place that is described in \ref{equivocation-case}. 



\section{Approval Checker Assignment}
\subsection{VRF computation}

Every validator needs to run Algorithm \ref{algo-checker-vrf} for every Parachain $\rho$ to determines assginments.

\begin{algorithm}
  \caption[VRF-for-Approval]{\sc VRF-for-Approval($B$, $z$, $s_k$)}
  \label{algo-checker-vrf}
  \begin{algorithmic}[1]
  \Require

    $B$: the block to be approved 

    $z$: randomness for approval assignmen

    $s_k$: session secret key of validator planning to participate in approval

    \State $(\pi, d) \leftarrow \sc{VRF}(H_h(B),sk(z))$
    \State \Return $(\pi,d)$
  \end{algorithmic}
\end{algorithm}

\begin{algorithm}
  \Require{}
  %%  \Ensure{}
  \caption[]{\sc }
  \begin{algorithmic}[1]
    \State
  \end{algorithmic}
\end{algorithm}

Where \sc{VRF} function is defined in \cite{polkadot-crypto-spec}.

\section{Distribution of Pieces}\label{distribute-piece}

\section{One Shot Assignment plus some extra assignemnts}\label{shot-assignment}
Validators assign themselves to PoV blocks that have been announced to be distributed. The assignemnt needs to be random. Using their own VRF to sign the VRF outpit from the current relay chain block. Each validaot takes the output of this VRF mod the number of parahcain blocks. This will give them the index of the PoV block they need to check. Note that each PoV block shold be assigned in average to the same number of validators as the number of parahcian validators.

Now in addition to this assigment some extra validatord are assigned to every PoV block as follows (the reason for this extra assignemtn is described in security analysis).

Let us assume we want $\alpha$ validators to check every PoV block during the secondary validity checking. Note that $\alpha$ is not a fixed number but depends on reports from collators or fishermen. Lets us assume $\beta$ is a number depending on the validators who we would expect to have checked the PoV block.  


Now each validator computes for each PoV block a VRF with the input being the relay chain block VRF concatinated with the parachain index. 

NOTATION

Every validator compares $\alpha - \beta$ to the output of its VRF and if the VRF output is small enough than the validator check the PoV blocks immidately otherwise depending on their VRF output validators wait for some time and only perform a check if they have not seen alpha checks from validators who either whether 1) parachain validtors of this PoV block 2) or assigned during one shot assigment or 3) had a smaller VRF output than us during this time. 
