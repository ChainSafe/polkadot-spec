version: 2

jobs:
  runTests:
    docker:
      - image: rustlang/rust:nightly-slim
    steps:
      - run: apt update; apt install -y git
      - checkout
      - run:
          name: install deps
          command: |
            apt update && apt install -y --no-install-recommends \
              build-essential \
              make \
              pkg-config \
              libssl-dev \
              clang \
              libclang-dev \
              wget \
              gcc-8 \
              g++-8 \
              golang \
              julia \
              python

            # Build and install CMake
            wget https://github.com/Kitware/CMake/releases/download/v3.16.0-rc4/cmake-3.16.0-rc4.tar.gz
            tar xzvf cmake-3.16.0-rc4.tar.gz
            cd cmake-3.16.0-rc4
            ./bootstrap && make && make install
            cd ../

            # Install toolchain required for Wasm
            rustup target add wasm32-unknown-unknown --toolchain nightly
            cargo install --git https://github.com/alexcrichton/wasm-gc

            # Set default gcc and g++ binaries to version 8
            ln -sf /usr/bin/gcc-8 /usr/bin/gcc
            ln -sf /usr/bin/g++-8 /usr/bin/g++

            # Debug statements
            echo "Toolchain versions:"
            rustc --version
            clang --version
            gcc --version
            g++ --version
            julia --version
            python --version
            cmake --version
      - run:
          name: run tests
          command: |
            ./run_tests.sh

workflows:
  version: 2
  tests:
    jobs:
      - runTests:
          filters:
            tags:
              only: /.*/
